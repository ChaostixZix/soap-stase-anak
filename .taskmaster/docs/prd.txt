ğŸ’¡ Claude Code â€“ Senior Engineer Build Brief

Project: SOAP Manager (patients for me & my GF)
Deliverables: Web app + Supabase schema & RLS + MCP server (patient tools) + Telegram bot + minimal host wiring + seed + docs
Languages: TypeScript/Node, SQL
Style: Minimal, clear, production-ready MVP

0) Rules of Engagement
	â€¢	Be decisive. If something is ambiguous, pick sensible defaults and note assumptions in ASSUMPTIONS.md.
	â€¢	Ship a working vertical slice first (CRUD + NL flow end-to-end), then iterate.
	â€¢	Use small, readable modules; add comments where non-obvious.
	â€¢	Prefer SvelteKit (lighter than heavy React stacks) + Tailwind. If you must pick React, use Next.js App Router.
	â€¢	Use Supabase (Postgres + Auth + RLS).
	â€¢	Implement MCP server (Node SDK) over stdio with tools for patient search, disambiguation, and SOAP updates.
	â€¢	Implement Telegram Bot (webhook) that talks to our serverless endpoint, delegating to the same â€œNL commandâ€ handler used by the web UI.
	â€¢	Include makefile tasks for dev/run, and a single scripts/dev.sh one-liner.

â¸»

1) Product Scope (MVP)

Entities
	â€¢	Hospital: id (uuid), name (text, unique per user)
	â€¢	Bangsal (ward): id (uuid), hospital_id â†’ Hospital, name (text)
	â€¢	Patient: id (uuid), hospital_id â†’ Hospital, bangsal_id â†’ Bangsal, room_number (text), full_name (text), MRN (text, optional), created_by (user id)
	â€¢	SOAP: id, patient_id, s (text), o (text), a (text), p (jsonb array of â€œplan itemsâ€), created_at, updated_at
	â€¢	Plan item (inside SOAP.p array): { drug: string, route?: string, dose?: string, freq?: string, days?: number, start_date: date, end_date: date, status: "active"|"done" }

Core flows
	1.	Hospital/Bangsal Manager
	â€¢	Create hospital; create bangsal under hospital.
	2.	Patient Manager
	â€¢	Create patient (select hospital, bangsal, room).
	â€¢	View list by hospital/bangsal; search by name (â€œBintangâ€, â€œBintang Putraâ€, â€œNisaâ€).
	3.	SOAP
	â€¢	View latest SOAP (default to most recent).
	â€¢	Natural-language commands to read/update:
	â€¢	â€œApa diagnosis Bintang?â€ â†’ Disambiguate â€œBintangâ€ â†’ show Assessment (A) of latest SOAP.
	â€¢	â€œPasien Bintang tambahkan obat injeksi Cefotaxime untuk 2 hari.â€ â†’ Append a Plan item; auto compute end date = start_date + days; mark prior items done if end_date < today; split view with â€œPlan Aktifâ€ and â€œâ€” Plan Selesaiâ€.

NL Data Exposure Strategy (Important)
	â€¢	The AI does not see the entire DB.
	â€¢	For identification: expose patients(name, hospital_name, bangsal_name, room_number, id) via a search tool.
	â€¢	For read: expose only the latest SOAP row for a given patient and selected columns (a for diagnosis, and current p items).
	â€¢	For write: tools accept structured inputs (patient_id, plan item object, etc.) and perform validated DB writes. The model never writes raw SQL.

â¸»

2) Tech Stack & Packages
	â€¢	SvelteKit + Tailwind CSS
	â€¢	Supabase JS client & server helpers
	â€¢	MCP Server: @modelcontextprotocol/sdk, zod
	â€¢	Telegram: telegraf or minimal webhook using raw Bot API via undici
	â€¢	Date math: date-fns
	â€¢	Deploy target: Vercel or Supabase functions (your call; pick one and document)

â¸»

3) Database (SQL + RLS)

Create SQL migrations:

-- 01_schema.sql
create extension if not exists pg_trgm;

create table app_user (
  id uuid primary key default auth.uid(),
  created_at timestamptz not null default now()
);

create table hospital (
  id uuid primary key default gen_random_uuid(),
  owner_id uuid not null references app_user(id),
  name text not null,
  unique(owner_id, name)
);

create table bangsal (
  id uuid primary key default gen_random_uuid(),
  hospital_id uuid not null references hospital(id) on delete cascade,
  name text not null,
  unique(hospital_id, name)
);

create table patient (
  id uuid primary key default gen_random_uuid(),
  owner_id uuid not null references app_user(id),
  hospital_id uuid not null references hospital(id) on delete cascade,
  bangsal_id uuid not null references bangsal(id),
  room_number text,
  full_name text not null,
  mrn text,
  created_at timestamptz not null default now()
);
create index on patient using gin (full_name gin_trgm_ops);

create table soap (
  id uuid primary key default gen_random_uuid(),
  patient_id uuid not null references patient(id) on delete cascade,
  s text,
  o text,
  a text, -- diagnosis/assessment
  p jsonb not null default '[]', -- plan items array
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);
create index on soap(patient_id, created_at desc);

-- 02_rls.sql
alter table app_user enable row level security;
alter table hospital enable row level security;
alter table bangsal enable row level security;
alter table patient enable row level security;
alter table soap enable row level security;

create policy "users see self" on app_user
  for select using (id = auth.uid());

create policy "owner rw hospitals" on hospital
  using (owner_id = auth.uid())
  with check (owner_id = auth.uid());

create policy "rw bangsal under my hospitals" on bangsal
  using (exists (select 1 from hospital h where h.id = bangsal.hospital_id and h.owner_id = auth.uid()))
  with check (exists (select 1 from hospital h where h.id = bangsal.hospital_id and h.owner_id = auth.uid()));

create policy "rw my patients" on patient
  using (owner_id = auth.uid())
  with check (owner_id = auth.uid());

create policy "rw soap for my patients" on soap
  using (exists (select 1 from patient p where p.id = soap.patient_id and p.owner_id = auth.uid()))
  with check (exists (select 1 from patient p where p.id = soap.patient_id and p.owner_id = auth.uid()));

Seed script (03_seed.sql) with hospitals, bangsal, and patients â€œBintangâ€, â€œBintang Putraâ€, â€œNisaâ€.

â¸»

4) MCP Server (Node, stdio)

Create mcp/soap-tools.mjs:
	â€¢	Tools
	1.	patient.searchByName
Input: { name: string }
Behavior: fuzzy search patients owned by current user; return up to 5 candidates {id,name,hospital,bangsal,room}.
	2.	soap.getLatest
Input: { patient_id: string, select?: ("a"|"p"|"summary")[] }
Behavior: fetch latest SOAP; if select unspecified, return a and active p.
	3.	soap.appendPlanItem
Input: { patient_id, item: { drug, route?, dose?, freq?, days?, start_date? } }
Behavior: compute start_date = today() if missing; end_date = start_date + days; push to p.
	4.	soap.recomputePlanStatuses
Input: { patient_id }
Behavior: mark status="done" where end_date < today, else active. Persist.
	â€¢	Security: The MCP server uses service-role key only when running server-side; expose safe subsets. No raw SQL surfaced to the model.
	â€¢	Transport: StdioServerTransport. Export bin in package.json so hosts can spawn it.

â¸»

5) Telegram Bot
	â€¢	/webhooks/telegram serverless endpoint that:
	â€¢	Verifies bot token.
	â€¢	Normalizes text â†’ calls the same NL handler used by web UI.
	â€¢	Uses disambiguation flow: if â€œBintangâ€ matches 2 patients, reply with quick replies to choose.
	â€¢	Commands to support:
	â€¢	â€œdiagnosis bintangâ€ â†’ use patient.searchByName then soap.getLatest(select:["a"]).
	â€¢	â€œtambah obat â€¦ untuk 2 hariâ€ â†’ parse into structured plan; call appendPlanItem + recomputePlanStatuses.
	â€¢	Keep Indonesian phrasing in examples.

â¸»

6) Natural-Language Agent Design
	â€¢	The â€œagentâ€ runs inside our app (API route). It does not get raw table mirrors.
	â€¢	It calls MCP tools to search, disambiguate, read small slices, write structured updates.
	â€¢	Prompting strategy for the model (system prompt):

You are a clinical SOAP assistant for a small ward app.
- Never guess a patient; always disambiguate if multiple matches.
- For â€œdiagnosis X?â€ return the latest SOAP.A only.
- For â€œtambah obat â€¦ N hariâ€ create a Plan item with start_date=today if not given, end_date=start+N-1 inclusive.
- After writes, call recomputePlanStatuses and return a split view:
  Plan Aktif: [...]
  ---- Plan Selesai
  [...]
- All dates default to Asia/Jakarta.
- Use the structured MCP tools only; do not invent data.


	â¸»

7) Web App (SvelteKit)
	â€¢	Pages:
	â€¢	/ dashboard: filter by hospital â†’ bangsal; list patients with room number.
	â€¢	/hospitals, /bangsal, /patients/[id]
	â€¢	/patients/[id]/soap shows latest SOAP; editor for S,O,A; Plan viewer with active/done separator.
	â€¢	NL command box on patient page and top navbar: sends text to /api/nl, which orchestrates calls to MCP tools and returns structured result to render.

â¸»

8) Implementation Plan (Tasks)
	1.	Scaffold SvelteKit + Tailwind + Supabase client; auth with email link (or magic link).
	2.	DB: apply SQL migrations; enable RLS; add seed.
	3.	Data access: server routes for hospitals, bangsal, patients, SOAP CRUD (Zod validated).
	4.	MCP server: implement tools; env config for Supabase URL/key; bin script; README with how to register to a host (e.g., Claude Desktop).
	5.	NL orchestration: /api/nl mapping intents:
	â€¢	intent=ask_diagnosis(name) â†’ search â†’ maybe disambiguate â†’ getLatest.a
	â€¢	intent=add_medication(name, item) â†’ search â†’ append â†’ recompute â†’ return split plan
	6.	Telegram: webhook endpoint + command parser; doc for setting webhook.
	7.	UI: hospital/bangsal managers; patient list; patient profile; SOAP screen with Plan active/done.
	8.	Tests: minimal API unit tests for plan recompute & append.
	9.	Docs: README.md, ASSUMPTIONS.md, .env.example, runbook, and POSTMAN.json.

â¸»

9) Parsing NL â†’ Plan Items
	â€¢	Accept forms like:
	â€¢	â€œInj. Cefotaxime 1g IV q8h 2 hariâ€
	â€¢	â€œInf. Paracetamol 1g PO bid 2 hari mulai 26 Augâ€
	â€¢	Extract: drug, route, dose, freq, days, optional start_date.
	â€¢	Compute end_date = start_date + days - 1.
	â€¢	status = active if end_date >= today, else done.

â¸»

10) Example Outputs (for the UI)

Plan Aktif
- Inj. Cefotaxime 1g IV q8h (2 hari, sampai 28 Aug)

---- Plan Selesai
- Inf. Paracetamol 1g PO bid (2 hari, selesai 27 Aug)


â¸»

11) File Layout

/app
  /src
    /routes
      +page.svelte
      /hospitals
      /bangsal
      /patients/[id]
      /api/nl/+server.ts
      /webhooks/telegram/+server.ts
    /lib/db.ts
    /lib/nl.ts    # intent detection + MCP calls
    /lib/plan.ts  # parse & recompute utilities
  /mcp
    soap-tools.mjs
  /sql
    01_schema.sql
    02_rls.sql
    03_seed.sql
  .env.example
  ASSUMPTIONS.md
  README.md
  scripts/dev.sh
  makefile


â¸»

12) Acceptance Criteria
	â€¢	I can:
	1.	Create hospital & bangsal; add patients with room numbers.
	2.	Ask in Indonesian: â€œApa diagnosis Bintang?â€ â†’ if two â€œBintangâ€, Iâ€™m asked which; then see diagnosis from latest SOAP.
	3.	â€œPasien Bintang tambahkan obat injeksi Cefotaxime untuk 2 hariâ€ â†’ plan appended; recompute splits active/done.
	4.	Do the same via Telegram chat.
	5.	MCP tools are callable (documented), with Zod-validated inputs.
	â€¢	RLS prevents cross-user access.
	â€¢	All dates handled in Asia/Jakarta.

â¸»

13) What to Hand Back
	â€¢	Source code as per file layout.
	â€¢	Supabase migration & seed applied instructions.
	â€¢	README.md with:
	â€¢	local dev setup
	â€¢	MCP registration steps (for Claude Desktop or simple host)
	â€¢	Telegram webhook setup commands
	â€¢	environment variables
	â€¢	Short demo GIF or steps to reproduce the 3 acceptance flows.

â¸»

Environment Variables (.env.example)

PUBLIC_SUPABASE_URL=
SUPABASE_SERVICE_ROLE_KEY=   # server-only
TELEGRAM_BOT_TOKEN=
TELEGRAM_WEBHOOK_SECRET=
TZ=Asia/Jakarta


â¸»

14) Extras (if time allows)
	â€¢	Add pg_trgm similarity threshold tuning.
	â€¢	Simple audit trail table for SOAP edits.
	â€¢	CSV export per bangsal.

â¸»

End of Brief

â¸»
